---
- name: Configure Nginx Web Server and Deploy App
  hosts: webservers # Targets both AWS and Azure machines defined in inventory.ini
  become: yes
  
  tasks:
    - name: 1. Ensure Nginx package is installed
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: yes
      
    - name: 2. Copy the customized index file to the web root (Cloud-Specific)
      ansible.builtin.copy:
        src: "{{ item.src }}" # Reference the source file from the dictionary item
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: '0644'
      loop:
        # Define cloud-specific source files
        - { src: index-aws.html, cloud: 'aws' }
        - { src: index-azure.html, cloud: 'azure' }
      when: 
        # Corrected logic: Run AWS file copy IF host is AWS OR run Azure file copy IF host is Azure
        - ('aws' in inventory_hostname and item.cloud == 'aws') or ('azure' in inventory_hostname and item.cloud == 'azure')
        
    - name: 3. Update Nginx default config file to prioritize index.html
      ansible.builtin.lineinfile:
        path: /etc/nginx/sites-available/default
        regexp: '^\s*index\s+.*'
        # Ensures index.html is the first file Nginx searches for
        line: '	index index.html index.htm index.nginx-debian.html;' 
        state: present
        backup: yes
      register: nginx_config_changed

    - name: 4. Ensure Nginx service is running and reload configuration if needed
      ansible.builtin.service:
        name: nginx
        # Use reloaded if config changed, otherwise just ensure it's running
        state: reloaded
        enabled: yes
      when: nginx_config_changed.changed or ansible_check_mode is not defined
